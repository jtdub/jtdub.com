---
layout: post
title: DMVPN with VRF's for the Internet interfaces and BGP
date: '2013-11-25T22:29:00.001-06:00'
author: jtdub
tags:
- DMVPN
- VRF
- BGP
- packetgeek.net
---

I've been playing with some different DMVPN configurations. In this scenario, I wanted the Internet facing interface to have a separate routing table, which I accomplished with a VRF. I also wanted to use a phase 2 DMVPN - which allows spokes to communicate directly to each other without having to send all traffic to the hub. The tricky part was getting the DMVPN tunnels to form over that interface. This is accomplished via the tunnel vrf command in the tunnel interface and specifying the vrf in the crypto keyring.
<br/>
<br/>
Here is my hub config:
<br/>
<br/>
<br/>
<pre class="lang:default decode:true">DMVPN-HUB1-R1#$l0/0.102|interface Loopback0|interface Tunnel0|ip prefix-list <br/>ip vrf Internet<br/> rd 500:1<br/>crypto keyring DMVPN vrf Internet<br/>  pre-shared-key address 0.0.0.0 0.0.0.0 key test123<br/>crypto isakmp policy 10<br/> authentication pre-share<br/> group 2<br/>crypto ipsec transform-set DMVPN ah-sha-hmac esp-aes 256 <br/> mode transport<br/>crypto ipsec profile DMVPN<br/> set transform-set DMVPN <br/>interface Loopback0<br/> ip vrf forwarding Internet<br/> ip address 151.0.0.1 255.255.255.0<br/>interface Tunnel0<br/> bandwidth 1544<br/> ip address 10.0.1.1 255.255.255.0<br/> no ip redirects<br/> ip mtu 1400<br/> ip nhrp authentication test123<br/> ip nhrp map multicast dynamic<br/> ip nhrp network-id 1234<br/> ip tcp adjust-mss 1360<br/> load-interval 30<br/> cdp enable<br/> tunnel source Loopback0<br/> tunnel mode gre multipoint<br/> tunnel key 12345<br/> tunnel vrf Internet<br/> tunnel protection ipsec profile DMVPN<br/>interface Serial0/0.102 point-to-point<br/> ip vrf forwarding Internet<br/> ip address 150.0.0.2 255.255.255.252<br/> frame-relay interface-dlci 102   <br/>router bgp 500<br/> no synchronization<br/> bgp log-neighbor-changes<br/> neighbor 10.0.1.2 remote-as 600<br/> neighbor 10.0.1.2 prefix-list TUN out<br/> no auto-summary<br/> !<br/> address-family ipv4 vrf Internet<br/>  neighbor 150.0.0.1 remote-as 100<br/>  neighbor 150.0.0.1 activate<br/>  neighbor 150.0.0.1 send-community<br/>  no synchronization<br/>  network 151.0.0.0 mask 255.255.255.0<br/> exit-address-family<br/>ip prefix-list BGP seq 5 permit 151.0.0.0/24<br/>ip prefix-list TUN seq 5 permit 10.0.1.0/24</pre>
<br/>
<br/>
Here is my spoke config:
<br/>
<br/>
<br/>
<pre class="lang:default decode:true">DMVPN-SPOKE1-R4#$interface Serial0/1/0|interface Tunnel0|interface Loopback0 <br/>ip vrf Internet<br/> rd 600:1<br/>crypto keyring DMVPN vrf Internet<br/>  pre-shared-key address 0.0.0.0 0.0.0.0 key test123<br/>crypto isakmp policy 10<br/> authentication pre-share<br/> group 2<br/>crypto ipsec transform-set DMVPN ah-sha-hmac esp-aes 256 <br/> mode transport<br/>crypto ipsec profile DMVPN<br/> set transform-set DMVPN <br/>interface Loopback0<br/> ip vrf forwarding Internet<br/> ip address 152.0.0.1 255.255.255.0<br/>interface Tunnel0<br/> bandwidth 1544<br/> ip address 10.0.1.2 255.255.255.0<br/> no ip redirects<br/> ip mtu 1400<br/> ip nhrp authentication test123<br/> ip nhrp map multicast dynamic<br/> ip nhrp map 10.0.1.1 151.0.0.1<br/> ip nhrp map multicast 151.0.0.1<br/> ip nhrp network-id 1234<br/> ip nhrp nhs 10.0.1.1<br/> ip tcp adjust-mss 1360<br/> load-interval 30<br/> cdp enable<br/> tunnel source Loopback0<br/> tunnel mode gre multipoint<br/> tunnel key 12345<br/> tunnel vrf Internet<br/> tunnel protection ipsec profile DMVPN<br/>interface Serial0/1/0<br/> ip vrf forwarding Internet<br/> ip address 150.0.0.10 255.255.255.252<br/> encapsulation ppp<br/> clock rate 1024000<br/>router bgp 600<br/> no synchronization<br/> bgp router-id 152.0.0.1<br/> bgp log-neighbor-changes<br/> neighbor 10.0.1.1 remote-as 500<br/> neighbor 10.0.1.1 prefix-list TUN out<br/> no auto-summary<br/> !<br/> address-family ipv4 vrf Internet<br/>  neighbor 150.0.0.9 remote-as 100<br/>  neighbor 150.0.0.9 activate<br/>  no synchronization<br/>  network 152.0.0.0 mask 255.255.255.0<br/> exit-address-family<br/>ip prefix-list BGP seq 5 permit 152.0.0.0/24<br/>ip prefix-list TUN seq 5 permit 10.0.1.0/24</pre>
<br/>
<br/>
One of the scenarios that I wanted to play with was having BGP dynamically create peers. However, my specific version of code doesn't support dynamic BGP peers. If my code did support it, the BGP config would look something like:
<br/>
<br/>
<br/>
<pre class="lang:default decode:true">! Configuration for the HUB<br/>router bgp 500<br/> neighbor spokes peer-group<br/> bgp listen range 10.0.1.0/24 peer-group spokes<br/> neighbor spokes remote-as 600<br/> neighbor spokes next-hop-self<br/> neighbor spokes send-community<br/><br/>! Configuration for the Spokes<br/>router bgp 600<br/> neighbor 10.0.1.1 remote-as 500<br/> neighbor 10.0.1.1 allowas-in 1</pre>
<br/>
<br/>
Update:
<br/>
<br/>
I had an interesting idea. Having the hub's and the spokes in the same BGP ASN. Having the DMVPN hubs act as BGP route reflectors and having the spoke connect to the hubs. As the hubs are route reflectors, they will propagate all routes about the spokes to all other spokes. In a DMVPN phase 2 scenario, this would allow the spokes to communicate next to each other as the spokes know about each other through BGP next-hop. I set it up in my lab and it actually works pretty well.
<br/>
<br/>
Here the BGP configuration from my hub:
<br/>
<br/>
<br/>
<pre class="lang:default decode:true">DMVPN-HUB1-R1#sh run | s router bgp<br/>router bgp 500<br/> template peer-policy spokes<br/>  route-reflector-client<br/>  soft-reconfiguration inbound<br/>  send-community<br/> exit-peer-policy<br/> !<br/> template peer-session spokes<br/>  remote-as 500<br/> exit-peer-session<br/> !<br/> no synchronization<br/> bgp cluster-id 10.0.1.1<br/> bgp log-neighbor-changes<br/> network 10.10.10.0 mask 255.255.255.0<br/> neighbor spokes peer-group<br/> neighbor 10.0.1.2 inherit peer-session spokes<br/> neighbor 10.0.1.2 inherit peer-policy spokes<br/> neighbor 10.0.1.3 inherit peer-session spokes<br/> neighbor 10.0.1.3 inherit peer-policy spokes<br/> no auto-summary<br/> !<br/> address-family ipv4 vrf Internet<br/>  neighbor 150.0.0.1 remote-as 100<br/>  neighbor 150.0.0.1 activate<br/>  neighbor 150.0.0.1 send-community<br/>  neighbor 150.0.0.1 allowas-in<br/>  no synchronization<br/>  network 151.0.0.0 mask 255.255.255.0<br/> exit-address-family<br/></pre>
<br/>
<br/>
Here is the BGP configuration from one of my spokes:
<br/>
<br/>
<br/>
<pre class="lang:default decode:true">DMVPN-SPOKE1-R4#sh run | s router bgp<br/>router bgp 500<br/> template peer-policy hub<br/>  prefix-list TUN out<br/>  soft-reconfiguration inbound<br/>  send-community<br/> exit-peer-policy<br/> !<br/> template peer-session hub<br/>  remote-as 500<br/> exit-peer-session<br/> !<br/> no synchronization<br/> bgp log-neighbor-changes<br/> network 10.10.20.0 mask 255.255.255.0<br/> neighbor 10.0.1.1 inherit peer-session hub<br/> neighbor 10.0.1.1 inherit peer-policy hub<br/> no auto-summary<br/> !<br/> address-family ipv4 vrf Internet<br/>  neighbor 150.0.0.9 remote-as 100<br/>  neighbor 150.0.0.9 activate<br/>  neighbor 150.0.0.9 send-community<br/>  neighbor 150.0.0.9 allowas-in<br/>  no synchronization<br/>  network 152.0.0.0 mask 255.255.255.0<br/> exit-address-family<br/></pre>
<br/>
<br/>
Here is the isakmp session status, BGP table, and trace route to a neighbor spoke from the DMVPN-SPOKE1-R4 spoke.
<br/>
<br/>
<br/>
<pre class="lang:default decode:true">DMVPN-SPOKE1-R4#sh crypto isakmp sa<br/>dst             src             state          conn-id slot status<br/>151.0.0.1       152.0.0.1       QM_IDLE              1    0 ACTIVE<br/>152.0.0.1       153.0.0.1       QM_IDLE              2    0 ACTIVE<br/><br/>DMVPN-SPOKE1-R4#sh ip bgp sum<br/>BGP router identifier 10.10.20.1, local AS number 500<br/>BGP table version is 14, main routing table version 14<br/>3 network entries using 351 bytes of memory<br/>3 path entries using 156 bytes of memory<br/>6/2 BGP path/bestpath attribute entries using 744 bytes of memory<br/>1 BGP rrinfo entries using 24 bytes of memory<br/>2 BGP AS-PATH entries using 48 bytes of memory<br/>0 BGP route-map cache entries using 0 bytes of memory<br/>0 BGP filter-list cache entries using 0 bytes of memory<br/>BGP using 1323 total bytes of memory<br/>BGP activity 14/6 prefixes, 18/10 paths, scan interval 60 secs<br/><br/>Neighbor        V    AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd<br/>10.0.1.1        4   500     263     252       14    0    0 03:42:25        2<br/>DMVPN-SPOKE1-R4#sh ip bgp <br/>BGP table version is 14, local router ID is 10.10.20.1<br/>Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal,<br/>              r RIB-failure, S Stale<br/>Origin codes: i - IGP, e - EGP, ? - incomplete<br/><br/>   Network          Next Hop            Metric LocPrf Weight Path<br/>*&gt;i10.10.10.0/24    10.0.1.1                 0    100      0 i<br/>*&gt; 10.10.20.0/24    0.0.0.0                  0         32768 i<br/>*&gt;i10.10.30.0/24    10.0.1.3                 0    100      0 i<br/>DMVPN-SPOKE1-R4#ping 10.10.30.1<br/><br/>Type escape sequence to abort.<br/>Sending 5, 100-byte ICMP Echos to 10.10.30.1, timeout is 2 seconds:<br/>!!!!!<br/>Success rate is 100 percent (5/5), round-trip min/avg/max = 4/13/24 ms<br/>DMVPN-SPOKE1-R4#tracero<br/>DMVPN-SPOKE1-R4#traceroute 10.10.30.1<br/><br/>Type escape sequence to abort.<br/>Tracing the route to 10.10.30.1<br/><br/>  1 10.0.1.3 4 msec 4 msec * <br/></pre>
<br/>
<br/>
One way to make this scale, without manual intervention of having to add neighbor relationships in BGP would be to have the dynamic neighbor relations statement in the DMVPN hubs. In my lab set up, BGP works pretty well in a DMVPN environment.
