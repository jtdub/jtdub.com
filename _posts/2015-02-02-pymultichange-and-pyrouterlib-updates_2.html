---
layout: post
title: pyMultiChange and pyRouterLib Updates
date: '2015-02-02T17:48:00.001-06:00'
author: jtdub
tags:
- Cisco Administration Python Scripting
- Python Tips
- packetgeek.net
---

I recently had a request to combine the SSH and TELNET functionality on my
<a href="https://github.com/jtdub/pyMultiChange" target="_blank">
 pyMultiChange
</a>
scripts, as they share a lot of code. I thought that this was a reasonable request, so I started that process today.
<br/>
<br/>
First off, I updated the
<a href="https://github.com/jtdub/pyRouterLib" target="_blank">
 pyRouterLib
</a>
to be more pep8 complaint. Once that was updated, I tossed the library into the pyMultiChange project, for consumption.
<br/>
<br/>
Currently, 'telnet-multi.py' and 'ssh-multi.py' are still available, but I plan on phasing them out, after I test 'multi.py' more.
<br/>
<br/>
Here is the code of the new 'args' library:
<br/>
<pre class="lang:python decode:true">import argparse<br/><br/>hosts_file = ''<br/>command_file = ''<br/>protocol = 'ssh'<br/>command_output = False<br/>verbose = False<br/><br/><br/>def default_args(hosts_file, command_file, protocol, command_output, verbose):<br/>    parser = argparse.ArgumentParser(description='Managing Cisco routers/switches with Python')<br/>    parser.add_argument('-d', '--hosts', help='Specifies a host file')<br/>    parser.add_argument('-c', '--commands',  help='Specifies a commands file', required=True)<br/>    parser.add_argument('-s', '--ssh', help='Default: Use the SSH protocol', nargs='?', const='ssh')<br/>    parser.add_argument('-t', '--telnet', help='Use the Telnet protocol', nargs='?', const='telnet')<br/>    parser.add_argument('-o', '--output', help='Be verbose with command output', nargs='?', const=True)<br/>    parser.add_argument('-v', '--verbose', help='Debug script output', nargs='?', const=True)<br/><br/>    args = vars(parser.parse_args())<br/><br/>    if args['hosts']:<br/>        hosts_file = args['hosts']<br/>    if args['commands']:<br/>        command_file = args['commands']<br/>    if args['telnet']:<br/>        protocol = 'telnet'<br/>    if args['ssh']:<br/>        protocol = 'ssh'<br/>    if args['output']:<br/>        command_output = args['output']<br/>    if args['verbose']:<br/>        verbose = args['verbose']<br/><br/>    return hosts_file, command_file, protocol, command_output, verbose</pre>
<br/>
Next, Here is the combined functionality of the multi change script, called multi.py:
<br/>
<pre class="lang:python decode:true">#!/usr/bin/env python<br/><br/>from lib.new_args import default_args<br/>from lib.new_args import hosts_file<br/>from lib.new_args import command_file<br/>from lib.new_args import protocol<br/>from lib.new_args import command_output<br/>from lib.new_args import verbose<br/>from lib.pyRouterLib import RouterLib<br/><br/>import os<br/>import time<br/>import sys<br/><br/>access_params = ''<br/><br/><br/>def access(method):<br/>    global access_params<br/>    if method == 'ssh':<br/>        access_params = access_method.use_ssh(host, RouterLib.username,<br/>                                              RouterLib.password)<br/>    elif method == 'telnet':<br/>        access_params = access_method.use_telnet(host, RouterLib.username,<br/>                                                 RouterLib.password)<br/>    else:<br/>        access_paams = ''<br/>        return """<br/>        You must use a proper connection method.<br/>        Currently telnet and ssh are supported.<br/>        """<br/><br/>    return method, access_params<br/><br/><br/>if __name__ == '__main__':<br/>    args = default_args(hosts_file, command_file, protocol, command_output,<br/>                        verbose)<br/>    hosts_file = args[0]<br/>    command_file = args[1]<br/>    protocol = args[2].lower()<br/>    command_output = args[3]<br/>    verbose = args[4]<br/><br/>    if not os.path.isfile(hosts_file):<br/>        print "Error: Invalid Hosts File"<br/>        exit(1)<br/>    if not os.path.isfile(command_file):<br/>        print "Error: Invalid Commands File"<br/>        exit(1)<br/>    if verbose is True:<br/>        import logging<br/>        logging.basicConfig(level=logging.DEBUG)<br/>    access_method = RouterLib()<br/>    hosts = open(hosts_file, 'r')<br/>    if verbose is True:<br/>        logging.debug(' Reading hosts file.')<br/>    for host in hosts:<br/>        host = host.strip()<br/>        if verbose is True:<br/>            logging.debug(' Reading %s from the hosts file.' % host)<br/>        """<br/>        Set up the connection using SSH (default) or Telnet.<br/>        """<br/>        if protocol == 'ssh':<br/>            if verbose is True:<br/>                logging.debug(' Attempting to access %s via SSH.' % host)<br/>            try:<br/>                if verbose is True:<br/>                    logging.debug(' Establishing ssh connection to %s.' % host)<br/>                access(method='ssh')<br/>                access_cmd = access_params[-1]<br/>                access_shell = access_cmd.invoke_shell()<br/>                shell_output = access_shell.recv(1000)<br/>                if '&gt;' in shell_output:<br/>                    if verbose is True:<br/>                        logging.debug(' Entering enable credentials')<br/>                    access_shell.send('enable\n')<br/>                    time.sleep(1)<br/>                    shell_output = access_shell.recv(1000)<br/>                    if 'Password:' in shell_output:<br/>                        access_shell.send(RouterLib.enable + '\n')<br/>                        time.sleep(1)<br/>                        shell_output = access_shell.recv(1000)<br/>                        if '#' in shell_output:<br/>                            if verbose is True:<br/>                                logging.debug(' Successfully entered enable mode.')<br/>                            access_shell.send('terminal length 0\n')<br/>                            shell_output = access_shell.recv(1000)<br/>                            if verbose is True:<br/>                                logging.debug(' Setting an unlimited terminal buffer.')<br/>                    else:<br/>                        if verbose is True:<br/>                            logging.debug(' Unable to enter enable mode.')<br/>                elif '#' in shell_output:<br/>                    access_shell.send('terminal length 0\n')<br/>                    shell_output = access_shell.recv(1000)<br/>                    if verbose is True:<br/>                        logging.debug(' Setting an unlimited terminal buffer.')<br/>            except:<br/>                logging.debug(' SKIPPING: %s doesn\'t support SSH.' % host)<br/>                exit(1)<br/>        elif protocol == 'telnet':<br/>            if verbose is True:<br/>                logging.debug(' Attempting to access %s via Telnet.' % host)<br/>            try:<br/>                if verbose is True:<br/>                    logging.debug(' Establishing telnet connection to %s.' % host)<br/>                access(method='telnet')<br/>                access_cmd = access_params[-1]<br/>            except:<br/>                logging.debug(' SKIPPING: %s doesn\'t support Telnet.' % host)<br/>                exit(1)<br/>        else:<br/>            access(method='none')<br/>        """<br/>        Run through the commands in the commands files.<br/>        """<br/>        cmds = open(command_file, 'r')<br/>        if verbose is True:<br/>            logging.debug(' Reading the commands file.')<br/>        for command in cmds:<br/>            command = command.strip()<br/>            if verbose is True:<br/>                logging.debug(' Executing: %s' % command)<br/>            if protocol == 'ssh':<br/>                access_shell.send(command + '\n')<br/>                time.sleep(2)<br/>                shell_output = access_shell.recv(1000000)<br/>                if command_output is True:<br/>                    print shell_output<br/>            if protocol == 'telnet':<br/>                access_cmd.write(command + '\n')<br/>                shell_output = access_cmd.read_until('#', 2)<br/>                if verbose is True:<br/>                    logging.debug(' Executing: %s' % command)<br/>                if command_output is True:<br/>                    print shell_output<br/>        """<br/>        Close the sessions and files.<br/>        """<br/>        access_cmd.close()<br/>        if verbose is True:<br/>            logging.debug(' Closing connection to %s.' % host)<br/>        cmds.close()<br/>        if verbose is True:<br/>            logging.debug(' Closing commands file.')<br/>    hosts.close()<br/>    if verbose is True:<br/>        logging.debug(' Closing hosts file.')</pre>
<br/>
Feel free to fork it, make changes, and submit pull requests to either project. I welcome any feedback!
<br/>
<ul>
 <br/>
 <li>
  <a href="https://github.com/jtdub/pyRouterLib" target="_blank">
   pyRouterLib
  </a>
 </li>
 <br/>
 <li>
  <a href="https://github.com/jtdub/pyMultiChange" target="_blank">
   pyMultiChange
  </a>
 </li>
 <br/>
</ul>