---
layout: post
title: Cisco Zone Based Firewall and UDP based Traceroute
date: '2013-04-11T11:03:00.001-05:00'
author: jtdub
tags:
- IOS
- IOS Security
- Cisco Firewalls
- Cisco Zone Based Firewall
- packetgeek.net
---

I've been using the Cisco Zone Based Firewall features in IOS for a little while now. Mostly at home and in a lab environment. One of the things that was kind of frustrating was that was the lack of outbound traceroute support from the trusted network to the untrusted network. I only use Linux and MacOS X at work and at home, so I never tried it out with a Microsoft based computer. I've also haven't really been able to spend a lot of time to really debug the issue. Recently, I did some digging through the documentation on Cisco's website and it hit me and it was such a simple answer. Linux/UNIX based operating systems use a UDP method for sending traceroute packets, while Windows based operating systems use a ICMP based method. As UDP is a connectionless protocol and there isn't any method for keeping a state table for UDP packets in the firewall, you have to allow ICMP host-unreachables and time-exceeded packets IN to the untrusted interface, destined for the trusted network. Here is a sample configuration.
<br/>
<pre class="lang:default decode:true">jtdub-rtr#sh run | s ^ip access-list extended udp-icmp|^class-map|^policy-map|^zone|^interface Vlan[1,2]|^interface FastEthernet0<br/>class-map type inspect match-any UDP_ICMP<br/>  match access-group name udp-icmp<br/>class-map type inspect match-any All_Protocols<br/>  match protocol icmp<br/>  match protocol tcp<br/>  match protocol udp<br/>policy-map type inspect Traceroute<br/>  class type inspect UDP_ICMP<br/>   pass<br/>  class class-default<br/>   drop<br/>policy-map type inspect All_Protocols<br/>   class type inspect All_Protocols<br/>    inspect <br/>  class class-default<br/>   drop<br/>policy-map type inspect UnTrusted<br/>  class class-default<br/>   drop<br/>zone security Trusted<br/>zone security Internet<br/>zone-pair security Trusted source Trusted destination Internet<br/>  service-policy type inspect All_Protocols<br/>zone-pair security Internet source Internet destination Trusted<br/>  service-policy type inspect Traceroute<br/>interface FastEthernet0<br/>  ip address dhcp<br/>  ip verify unicast source reachable-via rx allow-default 101<br/>  no ip redirects<br/>  no ip unreachables<br/>  no ip proxy-arp<br/>  ip nbar protocol-discovery<br/>  ip nat outside<br/>  ip virtual-reassembly<br/>  zone-member security Internet<br/>  duplex auto<br/>  speed auto<br/>  no cdp enable<br/>interface Vlan1<br/>  ip address 172.16.1.1 255.255.255.0<br/>  no ip redirects<br/>  no ip unreachables<br/>  no ip proxy-arp<br/>  ip nat inside<br/>  ip virtual-reassembly<br/>  zone-member security Trusted<br/>interface Vlan2<br/>  ip address 172.16.2.1 255.255.255.0<br/>  no ip redirects<br/>  no ip unreachables<br/>  no ip proxy-arp<br/>  ip nat inside<br/>  ip virtual-reassembly<br/>  zone-member security Trusted<br/>ip access-list extended udp-icmp<br/>  permit icmp any any time-exceeded<br/>  permit icmp any any host-unreachable</pre>
<br/>
As you can see, there is an extended ip access-list called udp-icmp that permits time-exceeded and host-unreachable icmp types, then a class map called UDP_ICMP was created to match that access-list, Then a policy-map called Traceroute was created to allow that class-map, from there, the policy-map was applied to a zone-member and applied to the untrusted interface.
