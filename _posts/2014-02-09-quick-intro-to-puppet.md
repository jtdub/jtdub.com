---
layout: post
title: Quick intro to Puppet
date: '2014-02-09'
author: jtdub
tags:
- Linux
- Puppet
- packetgeek.net
---

I've been using puppet for a while to automate several things within the Linux servers that I manage. It's also one of those things that if I don't use it in a while, I forget it. So, I'm going to do a quick run through of registering a puppet agent with a puppet master. I'll also show some of the things that every Linux install gets pushed, aka the default settings.
<br/>
<br/>
Here is my default manifest that every system gets:
<br/>
<br/>
<br/>
<pre class="lang:default decode:true">[root@bastion ~]# cat /etc/puppet/manifests/site.pp <br/>node default {<br/>	file { "/etc/yum.repos.d/drivesrvr.repo":<br/>		mode =&gt; '644',<br/>		owner =&gt; root,<br/>		group =&gt; root,<br/>		source =&gt; "puppet:///files/drivesrvr.repo",<br/>	}<br/>        file { "/etc/hosts":<br/>		mode =&gt; '644',<br/>		owner =&gt; root,<br/>		group =&gt; root,<br/>                source =&gt; "puppet:///files/hosts",<br/>        }<br/>        file { "/etc/ssh/sshd_config":<br/>                mode =&gt; '600',<br/>                owner =&gt; root,<br/>                group =&gt; root,<br/>                source =&gt; "puppet:///files/sshd_config",<br/>        }<br/>        file { "/etc/pam.d/su":<br/>                mode =&gt; '644',<br/>                owner =&gt; root,<br/>                group =&gt; root,<br/>                source =&gt; "puppet:///files/su",<br/>        }<br/>	file { "/etc/sudoers":<br/>                mode =&gt; '440',<br/>                owner =&gt; root,<br/>                group =&gt; root,<br/>		source =&gt; "puppet:///files/sudoers",<br/>	}<br/>	file { "/etc/selinux/config":<br/>		mode =&gt; '644',<br/>		owner =&gt; root,<br/>		group =&gt; root,<br/>		source =&gt; "puppet:///files/selinux",<br/>	}<br/>	file { "/etc/yum.repos.d/epel.repo":<br/>		mode =&gt; '644',<br/>		owner =&gt; root,<br/>		group =&gt; root,<br/>		source =&gt; "puppet:///files/epel.repo",<br/>	}<br/>        file { "/etc/yum.repos.d/epel-testing.repo":<br/>                mode =&gt; '644',<br/>                owner =&gt; root,<br/>                group =&gt; root,<br/>                source =&gt; "puppet:///files/epel-testing.repo",<br/>        }<br/>        file { "/etc/logrotate.conf":<br/>                mode =&gt; '644',<br/>                owner =&gt; root,<br/>                group =&gt; root,<br/>                source =&gt; "puppet:///files/logrotate.conf",<br/>        }<br/>        file { "/etc/sysconfig/clock":<br/>                mode =&gt; '644',<br/>                owner =&gt; root,<br/>                group =&gt; root,<br/>                source =&gt; "puppet:///files/clock",<br/>        }<br/>	package { "denyhosts": <br/>		ensure =&gt; installed,<br/>	}<br/>	package { "mailx":<br/>		ensure =&gt; installed,<br/>	}<br/>	package { "vim-enhanced":<br/>		ensure =&gt; installed,<br/>	}<br/>	package { "yum-cron":<br/>		ensure =&gt; installed,<br/>	}<br/>        package { "driveclient":<br/>		ensure =&gt; installed,<br/>	}<br/>	service { "yum-cron":<br/>		ensure =&gt; running,<br/>		enable =&gt; true,<br/>		subscribe =&gt; [Package["yum-cron"]],<br/>	}<br/>	service { "denyhosts":<br/>		ensure =&gt; running,<br/>		enable =&gt; true,<br/>		subscribe =&gt; [Package["denyhosts"]],<br/>	}<br/>	service { "driveclient":<br/>		ensure =&gt; running,<br/>		enable =&gt; true,<br/>		subscribe =&gt; [Package["driveclient"]],<br/>	}<br/>	#class timezone-base {<br/>    	#	package { "tzdata":<br/>        #	ensure =&gt; installed<br/>    	#	}<br/>    	#	file { "/etc/localtime":<br/>        #		source =&gt; "file:///usr/share/zoneinfo/America/Chicago",<br/>        #		require =&gt; Package["tzdata"]<br/>    	#	}<br/>	#}<br/>	#class timezone-central inherits timezone-base {<br/>	#}<br/>	user { "defaultuser":<br/>		allowdupe =&gt; false,<br/>		comment =&gt; "some default user",<br/>		ensure =&gt; present,<br/>		groups =&gt; ['wheel'],<br/>		home =&gt; "/home/defaultuser",<br/>		managehome =&gt; true,<br/>		shell =&gt; '/bin/bash'<br/>		#password =&gt; '', <br/>	}<br/>}<br/></pre>
<br/>
<br/>
The first thing that I do is install puppet on the new agent (client) node.
<br/>
<br/>
<br/>
<pre class="lang:default decode:true">[root@puppet ~]# yum -y install puppet<br/>Loaded plugins: fastestmirror<br/>Determining fastest mirrors<br/>base                                                                                                                                                                                        | 3.7 kB     00:00     <br/>base/primary_db                                                                                                                                                                             | 4.4 MB     00:00     <br/>epel                                                                                                                                                                                        | 4.2 kB     00:00     <br/>epel/primary_db                                                                                                                                                                             | 5.9 MB     00:00     <br/>extras                                                                                                                                                                                      | 3.4 kB     00:00     <br/>extras/primary_db                                                                                                                                                                           |  19 kB     00:00     <br/>updates                                                                                                                                                                                     | 3.4 kB     00:00     <br/>updates/primary_db                                                                                                                                                                          | 1.4 MB     00:00     <br/>Setting up Install Process<br/>Resolving Dependencies<br/>--&gt; Running transaction check<br/>---&gt; Package puppet.noarch 0:2.7.23-1.el6 will be installed<br/>--&gt; Processing Dependency: facter &lt; 1:2.0 for package: puppet-2.7.23-1.el6.noarch<br/>--&gt; Processing Dependency: ruby(abi) &gt;= 1.8 for package: puppet-2.7.23-1.el6.noarch<br/>--&gt; Processing Dependency: ruby &gt;= 1.8.5 for package: puppet-2.7.23-1.el6.noarch<br/>--&gt; Processing Dependency: facter &gt;= 1.5 for package: puppet-2.7.23-1.el6.noarch<br/>--&gt; Processing Dependency: ruby-shadow for package: puppet-2.7.23-1.el6.noarch<br/>--&gt; Processing Dependency: ruby-augeas for package: puppet-2.7.23-1.el6.noarch<br/>--&gt; Processing Dependency: ruby(selinux) for package: puppet-2.7.23-1.el6.noarch<br/>--&gt; Processing Dependency: /usr/bin/ruby for package: puppet-2.7.23-1.el6.noarch<br/>--&gt; Running transaction check<br/>---&gt; Package facter.x86_64 0:1.6.18-3.el6 will be installed<br/>--&gt; Processing Dependency: virt-what for package: facter-1.6.18-3.el6.x86_64<br/>--&gt; Processing Dependency: pciutils for package: facter-1.6.18-3.el6.x86_64<br/>--&gt; Processing Dependency: dmidecode for package: facter-1.6.18-3.el6.x86_64<br/>---&gt; Package libselinux-ruby.x86_64 0:2.0.94-5.3.el6_4.1 will be installed<br/>---&gt; Package ruby.x86_64 0:1.8.7.352-13.el6 will be installed<br/>---&gt; Package ruby-augeas.x86_64 0:0.4.1-1.el6 will be installed<br/>--&gt; Processing Dependency: augeas-libs &gt;= 0.8.0 for package: ruby-augeas-0.4.1-1.el6.x86_64<br/>--&gt; Processing Dependency: libaugeas.so.0(AUGEAS_0.8.0)(64bit) for package: ruby-augeas-0.4.1-1.el6.x86_64<br/>--&gt; Processing Dependency: libaugeas.so.0(AUGEAS_0.12.0)(64bit) for package: ruby-augeas-0.4.1-1.el6.x86_64<br/>--&gt; Processing Dependency: libaugeas.so.0(AUGEAS_0.11.0)(64bit) for package: ruby-augeas-0.4.1-1.el6.x86_64<br/>--&gt; Processing Dependency: libaugeas.so.0(AUGEAS_0.10.0)(64bit) for package: ruby-augeas-0.4.1-1.el6.x86_64<br/>--&gt; Processing Dependency: libaugeas.so.0(AUGEAS_0.1.0)(64bit) for package: ruby-augeas-0.4.1-1.el6.x86_64<br/>--&gt; Processing Dependency: libaugeas.so.0()(64bit) for package: ruby-augeas-0.4.1-1.el6.x86_64<br/>---&gt; Package ruby-libs.x86_64 0:1.8.7.352-13.el6 will be installed<br/>--&gt; Processing Dependency: libreadline.so.5()(64bit) for package: ruby-libs-1.8.7.352-13.el6.x86_64<br/>---&gt; Package ruby-shadow.x86_64 0:1.4.1-13.el6 will be installed<br/>--&gt; Running transaction check<br/>---&gt; Package augeas-libs.x86_64 0:1.0.0-5.el6_5.1 will be installed<br/>---&gt; Package compat-readline5.x86_64 0:5.2-17.1.el6 will be installed<br/>---&gt; Package dmidecode.x86_64 1:2.11-2.el6 will be installed<br/>---&gt; Package pciutils.x86_64 0:3.1.10-2.el6 will be installed<br/>---&gt; Package virt-what.x86_64 0:1.11-1.2.el6 will be installed<br/>--&gt; Finished Dependency Resolution<br/><br/>Dependencies Resolved<br/><br/>===================================================================================================================================================================================================================<br/> Package                                                Arch                                         Version                                                   Repository                                     Size<br/>===================================================================================================================================================================================================================<br/>Installing:<br/> puppet                                                 noarch                                       2.7.23-1.el6                                              epel                                          3.0 M<br/>Installing for dependencies:<br/> augeas-libs                                            x86_64                                       1.0.0-5.el6_5.1                                           updates                                       309 k<br/> compat-readline5                                       x86_64                                       5.2-17.1.el6                                              base                                          130 k<br/> dmidecode                                              x86_64                                       1:2.11-2.el6                                              base                                           71 k<br/> facter                                                 x86_64                                       1.6.18-3.el6                                              epel                                           62 k<br/> libselinux-ruby                                        x86_64                                       2.0.94-5.3.el6_4.1                                        base                                           99 k<br/> pciutils                                               x86_64                                       3.1.10-2.el6                                              base                                           85 k<br/> ruby                                                   x86_64                                       1.8.7.352-13.el6                                          updates                                       534 k<br/> ruby-augeas                                            x86_64                                       0.4.1-1.el6                                               epel                                           21 k<br/> ruby-libs                                              x86_64                                       1.8.7.352-13.el6                                          updates                                       1.6 M<br/> ruby-shadow                                            x86_64                                       1.4.1-13.el6                                              epel                                           11 k<br/> virt-what                                              x86_64                                       1.11-1.2.el6                                              base                                           24 k<br/><br/>Transaction Summary<br/>===================================================================================================================================================================================================================<br/>Install      12 Package(s)<br/><br/>Total download size: 6.0 M<br/>Installed size: 15 M<br/>Downloading Packages:<br/>(1/12): augeas-libs-1.0.0-5.el6_5.1.x86_64.rpm                                                                                                                                              | 309 kB     00:00     <br/>(2/12): compat-readline5-5.2-17.1.el6.x86_64.rpm                                                                                                                                            | 130 kB     00:00     <br/>(3/12): dmidecode-2.11-2.el6.x86_64.rpm                                                                                                                                                     |  71 kB     00:00     <br/>(4/12): facter-1.6.18-3.el6.x86_64.rpm                                                                                                                                                      |  62 kB     00:00     <br/>(5/12): libselinux-ruby-2.0.94-5.3.el6_4.1.x86_64.rpm                                                                                                                                       |  99 kB     00:00     <br/>(6/12): pciutils-3.1.10-2.el6.x86_64.rpm                                                                                                                                                    |  85 kB     00:00     <br/>(7/12): puppet-2.7.23-1.el6.noarch.rpm                                                                                                                                                      | 3.0 MB     00:00     <br/>(8/12): ruby-1.8.7.352-13.el6.x86_64.rpm                                                                                                                                                    | 534 kB     00:00     <br/>(9/12): ruby-augeas-0.4.1-1.el6.x86_64.rpm                                                                                                                                                  |  21 kB     00:00     <br/>(10/12): ruby-libs-1.8.7.352-13.el6.x86_64.rpm                                                                                                                                              | 1.6 MB     00:00     <br/>(11/12): ruby-shadow-1.4.1-13.el6.x86_64.rpm                                                                                                                                                |  11 kB     00:00     <br/>(12/12): virt-what-1.11-1.2.el6.x86_64.rpm                                                                                                                                                  |  24 kB     00:00     <br/>-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br/>Total                                                                                                                                                                              9.8 MB/s | 6.0 MB     00:00     <br/>warning: rpmts_HdrFromFdno: Header V3 RSA/SHA256 Signature, key ID 0608b895: NOKEY<br/>Retrieving key from file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6<br/>Importing GPG key 0x0608B895:<br/> Userid : EPEL (6) &lt;epel@fedoraproject.org&gt;<br/> Package: epel-release-6-8.noarch (installed)<br/> From   : /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6<br/>Running rpm_check_debug<br/>Running Transaction Test<br/>Transaction Test Succeeded<br/>Running Transaction<br/>  Installing : 1:dmidecode-2.11-2.el6.x86_64                                                                                                                                                                  1/12 <br/>  Installing : virt-what-1.11-1.2.el6.x86_64                                                                                                                                                                  2/12 <br/>  Installing : augeas-libs-1.0.0-5.el6_5.1.x86_64                                                                                                                                                             3/12 <br/>  Installing : compat-readline5-5.2-17.1.el6.x86_64                                                                                                                                                           4/12 <br/>  Installing : ruby-libs-1.8.7.352-13.el6.x86_64                                                                                                                                                              5/12 <br/>  Installing : ruby-1.8.7.352-13.el6.x86_64                                                                                                                                                                   6/12 <br/>  Installing : ruby-augeas-0.4.1-1.el6.x86_64                                                                                                                                                                 7/12 <br/>  Installing : ruby-shadow-1.4.1-13.el6.x86_64                                                                                                                                                                8/12 <br/>  Installing : pciutils-3.1.10-2.el6.x86_64                                                                                                                                                                   9/12 <br/>  Installing : facter-1.6.18-3.el6.x86_64                                                                                                                                                                    10/12 <br/>  Installing : libselinux-ruby-2.0.94-5.3.el6_4.1.x86_64                                                                                                                                                     11/12 <br/>  Installing : puppet-2.7.23-1.el6.noarch                                                                                                                                                                    12/12 <br/>  Verifying  : libselinux-ruby-2.0.94-5.3.el6_4.1.x86_64                                                                                                                                                      1/12 <br/>  Verifying  : ruby-augeas-0.4.1-1.el6.x86_64                                                                                                                                                                 2/12 <br/>  Verifying  : facter-1.6.18-3.el6.x86_64                                                                                                                                                                     3/12 <br/>  Verifying  : ruby-libs-1.8.7.352-13.el6.x86_64                                                                                                                                                              4/12 <br/>  Verifying  : puppet-2.7.23-1.el6.noarch                                                                                                                                                                     5/12 <br/>  Verifying  : 1:dmidecode-2.11-2.el6.x86_64                                                                                                                                                                  6/12 <br/>  Verifying  : pciutils-3.1.10-2.el6.x86_64                                                                                                                                                                   7/12 <br/>  Verifying  : ruby-1.8.7.352-13.el6.x86_64                                                                                                                                                                   8/12 <br/>  Verifying  : virt-what-1.11-1.2.el6.x86_64                                                                                                                                                                  9/12 <br/>  Verifying  : compat-readline5-5.2-17.1.el6.x86_64                                                                                                                                                          10/12 <br/>  Verifying  : ruby-shadow-1.4.1-13.el6.x86_64                                                                                                                                                               11/12 <br/>  Verifying  : augeas-libs-1.0.0-5.el6_5.1.x86_64                                                                                                                                                            12/12 <br/><br/>Installed:<br/>  puppet.noarch 0:2.7.23-1.el6                                                                                                                                                                                     <br/><br/>Dependency Installed:<br/>  augeas-libs.x86_64 0:1.0.0-5.el6_5.1     compat-readline5.x86_64 0:5.2-17.1.el6     dmidecode.x86_64 1:2.11-2.el6        facter.x86_64 0:1.6.18-3.el6            libselinux-ruby.x86_64 0:2.0.94-5.3.el6_4.1    <br/>  pciutils.x86_64 0:3.1.10-2.el6           ruby.x86_64 0:1.8.7.352-13.el6             ruby-augeas.x86_64 0:0.4.1-1.el6     ruby-libs.x86_64 0:1.8.7.352-13.el6     ruby-shadow.x86_64 0:1.4.1-13.el6              <br/>  virt-what.x86_64 0:1.11-1.2.el6         <br/><br/>Complete!<br/></pre>
<br/>
<br/>
Next, I'll modify the /etc/hosts file and /etc/sysconfig/puppet file to specify my puppet master (puppet server).
<br/>
<br/>
<br/>
<pre class="lang:default decode:true">[root@puppet ~]# history | grep vi<br/>    2  vi /etc/hosts<br/>    3  vi /etc/sysconfig/puppet <br/>    4  history | grep vi<br/>[root@puppet ~]# cat /etc/hosts<br/>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br/>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br/><br/>172.17.0.5	puppet.test<br/><br/>172.17.0.1	puppetmaster<br/>[root@puppet ~]# cat /etc/sysconfig/puppet <br/># The puppetmaster server<br/>PUPPET_SERVER=puppetmaster<br/><br/># If you wish to specify the port to connect to do so here<br/>#PUPPET_PORT=8140<br/><br/># Where to log to. Specify syslog to send log messages to the system log.<br/>#PUPPET_LOG=/var/log/puppet/puppet.log<br/><br/># You may specify other parameters to the puppet client here<br/>#PUPPET_EXTRA_OPTS=--waitforcert=500</pre>
<br/>
<br/>
After that, I need to generate a ssl cert from the puppet agent to the puppet master.
<br/>
<br/>
<br/>
<pre class="lang:default decode:true">[root@puppet ~]# puppet agent --test --server puppetmaster<br/>info: Creating a new SSL key for puppet.test<br/>info: Caching certificate for ca<br/>info: Creating a new SSL certificate request for puppet.test<br/>info: Certificate Request fingerprint (md5): 1D:89:5C:D3:DD:A4:47:53:5B:A4:A2:BB:17:6A:55:B0<br/>Exiting; no certificate found and waitforcert is disabled<br/>[root@puppet ~]# <br/></pre>
<br/>
<br/>
When the key has been generated, hop on the puppetmaster server and sign the key.
<br/>
<br/>
<br/>
<pre class="lang:default decode:true">[root@puppetmaster ~]# puppet cert list<br/>  "puppet.test" (1D:89:5C:D3:DD:A4:47:53:5B:A4:A2:BB:17:6A:55:B0)<br/>[root@puppetmaster ~]# puppet cert sign puppet.test<br/>notice: Signed certificate request for puppet.test<br/>notice: Removing file Puppet::SSL::CertificateRequest puppet.test at '/var/lib/puppet/ssl/ca/requests/puppet.test.pem'</pre>
<br/>
<br/>
Now hop back onto the puppet agent and test the newly sign certificate. If all is good, it should push your default config to the server. For brevity, I'll leave out the output of everything that it set up.
<br/>
<br/>
<br/>
<pre class="lang:default decode:true">[root@puppet ~]# puppet agent --test --server puppetmaster<br/>info: Caching certificate for puppet.test<br/>info: Caching certificate_revocation_list for ca<br/>info: Caching catalog for puppet.test<br/>info: Applying configuration version '1392021450'<br/>……..<br/>info: Creating state file /var/lib/puppet/state/state.yaml<br/>notice: Finished catalog run in 19.31 seconds<br/></pre>
<br/>
<br/>
Finally, the last thing to do is start the puppet service, on the agent, and verify that its running.
<br/>
<br/>
<br/>
<pre class="lang:default decode:true">[root@puppet ~]# service puppet start<br/>Starting puppet:                                           [  OK  ]<br/>[root@puppet ~]# chkconfig puppet on<br/>[root@puppet ~]# ps ax | grep puppet<br/> 3330 ?        Ss     0:01 /usr/bin/ruby /usr/sbin/puppetd --server=puppetmaster<br/> 3538 pts/0    S+     0:00 grep puppet<br/></pre>
<br/>
<br/>
Now you should have a fully functional puppet installation. Now you can create puppet manifests to automate your server(s) even more!
