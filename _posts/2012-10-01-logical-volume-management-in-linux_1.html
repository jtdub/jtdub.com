---
layout: post
title: Logical Volume Management in Linux
date: '2012-10-01T06:06:00.001-05:00'
author: jtdub
tags:
- Linux
- Filesystems
- System Administration
- LVM
- packetgeek.net
---

LVM is a very powerful file system administration tool in Linux. It provides you with the ability to create, extend, resize, and even take snapshots of disk space on live systems. Here are my notes.  I created a new hard drive within my test VM. When the server booted, it sees the new drive as /dev/sda. The disk that's in use by Linux is /dev/vda.  To start, we'll need to partition /dev/sda. Note that you can only have four primary partitions on a single hard drive. Once you reach four primary partitions, if there is any space left on the disk, it will be unusable. Therefore, if you have a couple primary partitions, it's best to start using logical partitions.
<br/>
<br/>
<pre>[root@server1 ~]# fdisk -l | more<br/><br/><span style="background-color: yellow;">Disk /dev/sda</span>: 8589 MB, 8589934592 bytes<br/>255 heads, 63 sectors/track, 1044 cylinders<br/>Units = cylinders of 16065 * 512 = 8225280 bytes<br/>Sector size (logical/physical): 512 bytes / 512 bytes<br/>I/O size (minimum/optimal): 512 bytes / 512 bytes<br/>Disk identifier: 0x00000000<br/><br/><br/>Disk /dev/vda: 8589 MB, 8589934592 bytes<br/>16 heads, 63 sectors/track, 16644 cylinders<br/>Units = cylinders of 1008 * 512 = 516096 bytes<br/>Sector size (logical/physical): 512 bytes / 512 bytes<br/>I/O size (minimum/optimal): 512 bytes / 512 bytes<br/>Disk identifier: 0x000a2c27<br/><br/>   Device Boot      Start         End      Blocks   Id  System<br/>/dev/vda1   *           3        1018      512000   83  Linux<br/>Partition 1 does not end on cylinder boundary.<br/>/dev/vda2            1018       16645     7875584   8e  Linux LVM<br/>Partition 2 does not end on cylinder boundary.<br/><br/>Disk /dev/mapper/VolGroup-lv_root: 7021 MB, 7021264896 bytes<br/>255 heads, 63 sectors/track, 853 cylinders<br/>Units = cylinders of 16065 * 512 = 8225280 bytes<br/>Sector size (logical/physical): 512 bytes / 512 bytes<br/>I/O size (minimum/optimal): 512 bytes / 512 bytes<br/>Disk identifier: 0x00000000<br/><br/><br/>Disk /dev/mapper/VolGroup-lv_swap: 1040 MB, 1040187392 bytes<br/>255 heads, 63 sectors/track, 126 cylinders<br/>Units = cylinders of 16065 * 512 = 8225280 bytes<br/>Sector size (logical/physical): 512 bytes / 512 bytes<br/>I/O size (minimum/optimal): 512 bytes / 512 bytes<br/>Disk identifier: 0x00000000<br/></pre>
<br/>
<br/>
I then created a new 2GB primary partition on /dev/sda. This new primary partition is listed as a "Linux LVM" partition type Linux will see the partition as /dev/sda1. That leaves 6GB of free space in /dev/sda.
<br/>
<br/>
<pre>[root@server1 ~]# fdisk /dev/sda<br/>Device contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabel<br/>Building a new DOS disklabel with disk identifier 0xf1c3811e.<br/>Changes will remain in memory only, until you decide to write them.<br/>After that, of course, the previous content won't be recoverable.<br/><br/>Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)<br/><br/>WARNING: DOS-compatible mode is deprecated. It's strongly recommended to<br/>         switch off the mode (command 'c') and change display units to<br/>         sectors (command 'u').<br/><br/>Command (m for help): p<br/><br/>Disk /dev/sda: 8589 MB, 8589934592 bytes<br/>255 heads, 63 sectors/track, 1044 cylinders<br/>Units = cylinders of 16065 * 512 = 8225280 bytes<br/>Sector size (logical/physical): 512 bytes / 512 bytes<br/>I/O size (minimum/optimal): 512 bytes / 512 bytes<br/>Disk identifier: 0xf1c3811e<br/><br/>   Device Boot      Start         End      Blocks   Id  System<br/><br/>Command (m for help): n<br/>Command action<br/>   e   extended<br/>   p   primary partition (1-4)<br/>p<br/>Partition number (1-4): 1<br/>First cylinder (1-1044, default 1): <br/>Using default value 1<br/>Last cylinder, +cylinders or +size{K,M,G} (1-1044, default 1044): +2G<br/><br/>Command (m for help): p<br/><br/>Disk /dev/sda: 8589 MB, 8589934592 bytes<br/>255 heads, 63 sectors/track, 1044 cylinders<br/>Units = cylinders of 16065 * 512 = 8225280 bytes<br/>Sector size (logical/physical): 512 bytes / 512 bytes<br/>I/O size (minimum/optimal): 512 bytes / 512 bytes<br/>Disk identifier: 0xf1c3811e<br/><br/>   Device Boot      Start         End      Blocks   Id  System<br/>/dev/sda1               1         262     2104483+  83  Linux<br/><br/>Command (m for help): t<br/>Selected partition 1<br/>Hex code (type L to list codes): 8e<br/>Changed system type of partition 1 to 8e (Linux LVM)<br/><br/>Command (m for help): p<br/><br/>Disk /dev/sda: 8589 MB, 8589934592 bytes<br/>255 heads, 63 sectors/track, 1044 cylinders<br/>Units = cylinders of 16065 * 512 = 8225280 bytes<br/>Sector size (logical/physical): 512 bytes / 512 bytes<br/>I/O size (minimum/optimal): 512 bytes / 512 bytes<br/>Disk identifier: 0xf1c3811e<br/><br/>   Device Boot      Start         End      Blocks   Id  System<br/>/dev/sda1               1         262     2104483+  8e  Linux LVM<br/><br/>Command (m for help): w<br/>The partition table has been altered!<br/><br/>Calling ioctl() to re-read partition table.<br/>Syncing disks.<br/></pre>
<br/>
<br/>
Before I start, I'm going to run the pvs, vgs, and lvs commands so that you can see that I haven't modified anything, yet. Then I'll add my /dev/sda1 to a "Physical Volume".
<br/>
<br/>
<pre>root@server1 ~]# pvs<br/>  PV         VG       Fmt  Attr PSize PFree<br/>  /dev/vda2  VolGroup lvm2 a--  7.51g    0 <br/>[root@server1 ~]# vgs<br/>  VG       #PV #LV #SN Attr   VSize VFree<br/>  VolGroup   1   2   0 wz--n- 7.51g    0 <br/>[root@server1 ~]# lvs<br/>  LV      VG       Attr     LSize   Pool Origin Data%  Move Log Copy%  Convert<br/>  lv_root VolGroup -wi-ao--   6.54g                                           <br/>  lv_swap VolGroup -wi-ao-- 992.00m                                           <br/>[root@server1 ~]# ls /dev/sda1<br/>/dev/sda1<br/>[root@server1 ~]# <span style="background-color: lime;">pvcreate /dev/sda1</span><br/>  Writing physical volume data to disk "/dev/sda1"<br/>  Physical volume "/dev/sda1" successfully created<br/></pre>
<br/>
<br/>
Now is where you have to make your first decision. Do you want to create a new "Volume Group" or add the new drive to an existing "Volume Group". Both commands are simple. Creating a new volume group utilizes the vgcreate command, whereas extending the phsyical drive to an existing volume uses the vgextend command.
<br/>
To be able to show both methods, I first extended the physical volume into an existing volume group via the vgextend command. I then removed the the physical volume from the volume group so that I could demostrate creating a new volume group. You don't need to run through both commands. It's just a decision that you need to make when you're creating your volumes.
<br/>
<br/>
<pre>root@server1 ~]# vgs<br/>  VG       #PV #LV #SN Attr   VSize VFree<br/>  VolGroup   1   2   0 wz--n- 7.51g    0 <br/>[root@server1 ~]# vgextend VolGroup /dev/sda1<br/>  Volume group "VolGroup" successfully extended<br/>[root@server1 ~]# vgs<br/>  VG       #PV #LV #SN Attr   VSize VFree<br/>  VolGroup   2   2   0 wz--n- 9.51g 2.00g<br/>[root@server1 ~]# vgreduce -A y VolGroup /dev/sda1<br/>  Removed "/dev/sda1" from volume group "VolGroup"<br/>[root@server1 ~]# <span style="background-color: lime;">vgcreate VolGroup01 /dev/sda1</span><br/>  Volume group "VolGroup01" successfully created<br/>[root@server1 ~]# vgs<br/>  VG         #PV #LV #SN Attr   VSize VFree<br/>  VolGroup     1   2   0 wz--n- 7.51g    0 <br/>  <span style="background-color: yellow;">VolGroup01   1   0   0 wz--n- 2.00g 2.00g</span><br/></pre>
<br/>
<br/>
From here on, I'll continue with the new volume group "VolGroup01". After we have extended or created a new volume group, we'll need to create the actual logical volume. That includes needing to made a decision on the name of the volume, as well as the size of the volume. For this test, I'm going to create a volume called data and make it 1GB. That will leave 1GB for expansion or new volumes.
<br/>
<br/>
<pre>[root@server1 ~]# <span style="background-color: lime;">lvcreate -n data -L 1G VolGroup01</span><br/>  Logical volume "data" created<br/>[root@server1 ~]# pvs<br/>  PV         VG         Fmt  Attr PSize PFree<br/>  /dev/sda1  VolGroup01 lvm2 a--  2.00g 1.00g<br/>  /dev/vda2  VolGroup   lvm2 a--  7.51g    0 <br/>[root@server1 ~]# vgs<br/>  VG         #PV #LV #SN Attr   VSize VFree<br/>  VolGroup     1   2   0 wz--n- 7.51g    0 <br/>  <span style="background-color: yellow;">VolGroup01   1   1   0 wz--n- 2.00g 1.00g</span><br/>[root@server1 ~]# lvs<br/>  LV      VG         Attr     LSize   Pool Origin Data%  Move Log Copy%  Convert<br/>  lv_root VolGroup   -wi-ao--   6.54g                                           <br/>  lv_swap VolGroup   -wi-ao-- 992.00m                                           <br/>  <span style="background-color: yellow;">data    VolGroup01 -wi-a---   1.00g </span>     <br/></pre>
<br/>
<br/>
Once that is completed. You can create a file system, mount it, and start writing data to it.
<br/>
<br/>
<pre>[root@server1 ~]# <span style="background-color: lime;">mkfs -t ext4 /dev/VolGroup01/data</span> <br/>mke2fs 1.41.12 (17-May-2010)<br/>Filesystem label=<br/>OS type: Linux<br/>Block size=4096 (log=2)<br/>Fragment size=4096 (log=2)<br/>Stride=0 blocks, Stripe width=0 blocks<br/>65536 inodes, 262144 blocks<br/>13107 blocks (5.00%) reserved for the super user<br/>First data block=0<br/>Maximum filesystem blocks=268435456<br/>8 block groups<br/>32768 blocks per group, 32768 fragments per group<br/>8192 inodes per group<br/>Superblock backups stored on blocks: <br/> 32768, 98304, 163840, 229376<br/><br/>Writing inode tables: done                            <br/>Creating journal (8192 blocks): done<br/>Writing superblocks and filesystem accounting information: done<br/><br/>This filesystem will be automatically checked every 39 mounts or<br/>180 days, whichever comes first.  Use tune2fs -c or -i to override.<br/>[root@server1 ~]# <span style="background-color: lime;">mkdir /data</span><br/>[root@server1 ~]# <span style="background-color: lime;">mount /dev/VolGroup01/data /data/</span><br/>[root@server1 ~]# df -h<br/>Filesystem            Size  Used Avail Use% Mounted on<br/>/dev/mapper/VolGroup-lv_root<br/>                      6.5G  830M  5.3G  14% /<br/>tmpfs                 246M     0  246M   0% /dev/shm<br/>/dev/vda1             485M   32M  429M   7% /boot<br/><span style="background-color: yellow;">/dev/mapper/VolGroup01-data<br/>                     1008M   34M  924M   4% /data</span><br/>[root@server1 ~]# dd if=/dev/urandom of=/data/somefile bs=1M count=20<br/>20+0 records in<br/>20+0 records out<br/>20971520 bytes (21 MB) copied, 2.44909 s, 8.6 MB/s<br/>[root@server1 ~]# <span style="background-color: yellow;">md5sum /data/somefile &gt; /data/somefile.md5sum</span><br/>[root@server1 ~]# <span style="background-color: yellow;">cat /data/somefile.md5sum <br/>9437503c5996490b3518861e4d3754a7  /data/somefile</span><br/></pre>
<br/>
<br/>
Now let's say that I wanted to resize the volume. That could be done with the lvresize, lvextend, or lvreduce commands. Depending on what exactly you're wanting to do, but the lvresize is generally a better universal command as it will allow you to make the volume larger as well as shrink the volume. Shrinking a volume can be tricky, particularly if you have data on it. It's always a best practice to fensure that you have a proper backup of the volume, before you resize it. One of the switches with the lvresize command that will make life easier is the '-r' switch, which is the resize2fs, switch. When this switch is enabled, it will unmount the volume, which is needed to shrink the volume, but not extend the volume. It will also run a file system check on the volume and make sure that no data will get lost somewhere in translation, and remount the volume. Just be prepared to execute a restore if the process fails.
<br/>
<br/>
<pre>[root@server1 ~]# lvresize --help<br/>  lvresize: Resize a logical volume<br/><br/>lvresize<br/> [-A|--autobackup y|n]<br/> [--alloc AllocationPolicy]<br/> [-d|--debug]<br/> [-f|--force]<br/> [-h|--help]<br/> [-i|--stripes Stripes [-I|--stripesize StripeSize]]<br/> {-l|--extents [+|-]LogicalExtentsNumber[%{VG|LV|PVS|FREE|ORIGIN}] |<br/>  -L|--size [+|-]LogicalVolumeSize[bBsSkKmMgGtTpPeE]}<br/> [-n|--nofsck]<br/> [--noudevsync]<br/> [-r|--resizefs]<br/> [-t|--test]<br/> [--type VolumeType]<br/> [-v|--verbose]<br/> [--version]<br/> LogicalVolume[Path] [ PhysicalVolumePath... ]<br/><br/>[root@server1 ~]# <span style="background-color: lime;">lvresize -r -L -500M /dev/VolGroup01/data</span> <br/>Do you want to unmount "/data"? [Y|n] y<br/>fsck from util-linux-ng 2.17.2<br/>/dev/mapper/VolGroup01-data: 13/65536 files (7.7% non-contiguous), 17756/262144 blocks<br/>resize2fs 1.41.12 (17-May-2010)<br/>Resizing the filesystem on /dev/mapper/VolGroup01-data to 134144 (4k) blocks.<br/>The filesystem on /dev/mapper/VolGroup01-data is now 134144 blocks long.<br/><br/>  Reducing logical volume data to 524.00 MiB<br/>  Logical volume data successfully resized<br/>[root@server1 ~]# <span style="background-color: yellow;">df -h /data<br/>Filesystem            Size  Used Avail Use% Mounted on<br/>/dev/mapper/VolGroup01-data<br/>                      514M   53M  435M  11% /data</span><br/>[root@server1 ~]# ls /data/<br/>lost+found  somefile  somefile.md5sum<br/>[root@server1 ~]# <span style="background-color: yellow;">md5sum /data/somefile<br/>9437503c5996490b3518861e4d3754a7  /data/somefile</span><br/>[root@server1 ~]# <span style="background-color: yellow;">cat /data/somefile.md5sum <br/>9437503c5996490b3518861e4d3754a7  /data/somefile</span><br/><br/>[root@server1 ~]# <span style="background-color: lime;">lvresize -r -l +100%FREE /dev/VolGroup01/data</span> <br/>  Extending logical volume data to 2.00 GiB<br/>  Logical volume data successfully resized<br/>resize2fs 1.41.12 (17-May-2010)<br/>Filesystem at /dev/mapper/VolGroup01-data is mounted on /data; on-line resizing required<br/>old desc_blocks = 1, new_desc_blocks = 1<br/>Performing an on-line resize of /dev/mapper/VolGroup01-data to 525312 (4k) blocks.<br/>The filesystem on /dev/mapper/VolGroup01-data is now 525312 blocks long.<br/><br/>[root@server1 ~]# <span style="background-color: yellow;">md5sum /data/somefile<br/>9437503c5996490b3518861e4d3754a7  /data/somefile</span><br/>[root@server1 ~]# <span style="background-color: yellow;">cat /data/somefile.md5sum <br/>9437503c5996490b3518861e4d3754a7  /data/somefile</span><br/></pre>
<br/>
<br/>
As you can see, I shrunk the volume by 500M, verified that the data remained in tact and then grew the volume to the full space (extents) remaining. One of the gotchas with shrinking a volume is to make sure that nothing is accessing the volume that you want to shrink. You can accomplish this with the lsof command. If there are applications or people accessing the volume, you'll need to either stop the application or get the person to leave the volume as their working directory.
<br/>
One of the other cool features with LVM is being able to take snapshots. This can be accomplished with the lvcreate command in conjunction with the '-s' switch. You will need to have sufficiant space within your volume group to accomplish this.
<br/>
<br/>
<pre>[root@server1 ~]# <span style="background-color: lime;">lvcreate -s /dev/VolGroup01/data -L 250M -n data-snapshot</span><br/><span style="background-color: yellow;">  Rounding up size to full physical extent 252.00 MiB<br/>  Volume group "VolGroup01" has insufficient free space (0 extents): 63 required.</span><br/>[root@server1 ~]# <span style="background-color: lime;">vgs</span><br/>  VG         #PV #LV #SN Attr   VSize VFree<br/>  VolGroup     1   2   0 wz--n- 7.51g    0 <br/>  <span style="background-color: yellow;">VolGroup01   1   1   0 wz--n- 2.00g    0</span> <br/>[root@server1 ~]# <span style="background-color: lime;">lvresize -r -L 1GB /dev/VolGroup01/data </span><br/>Do you want to unmount "/data"? [Y|n] y<br/>fsck from util-linux-ng 2.17.2<br/>/dev/mapper/VolGroup01-data: 13/139264 files (15.4% non-contiguous), 22448/525312 blocks<br/>resize2fs 1.41.12 (17-May-2010)<br/>Resizing the filesystem on /dev/mapper/VolGroup01-data to 262144 (4k) blocks.<br/>The filesystem on /dev/mapper/VolGroup01-data is now 262144 blocks long.<br/><br/>  Reducing logical volume data to 1.00 GiB<br/>  Logical volume data successfully resized<br/>[root@server1 ~]# <span style="background-color: lime;">lvs</span><br/>  LV      VG         Attr     LSize   Pool Origin Data%  Move Log Copy%  Convert<br/>  lv_root VolGroup   -wi-ao--   6.54g                                           <br/>  lv_swap VolGroup   -wi-ao-- 992.00m                                           <br/>  <span style="background-color: yellow;">data    VolGroup01 -wi-ao--   1.00g</span>                                           <br/>[root@server1 ~]# <span style="background-color: lime;">lvcreate -s /dev/VolGroup01/data -L 250M -n data-snapshot</span><br/><span style="background-color: yellow;">  Rounding up size to full physical extent 252.00 MiB<br/>  Logical volume "data-snapshot" created</span><br/>[root@server1 ~]# lvs<br/>  LV            VG         Attr     LSize   Pool Origin Data%  Move Log Copy%  Convert<br/>  lv_root       VolGroup   -wi-ao--   6.54g                                           <br/>  lv_swap       VolGroup   -wi-ao-- 992.00m                                           <br/>  data          VolGroup01 owi-aos-   1.00g                                           <br/>  data-snapshot VolGroup01 swi-a-s- 252.00m      data     0.00                        <br/>[root@server1 ~]# <span style="background-color: lime;">mount /dev/VolGroup01/data-snapshot /mnt/</span><br/>[root@server1 ~]# <span style="background-color: yellow;">md5sum /mnt/somefile<br/>9437503c5996490b3518861e4d3754a7  /mnt/somefile</span><br/>[root@server1 ~]# <span style="background-color: yellow;">md5sum /data/somefile<br/>9437503c5996490b3518861e4d3754a7  /data/somefile</span><br/></pre>
<br/>
<br/>
As you can see, since I had previously extended the volume to encompass the full space, I had no space left over on the volume group. I then needed to reduce the size of the logical volume to make space available in the volume group for the snapshot creation.
